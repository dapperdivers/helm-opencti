apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "opencti.fullname" . }}-server
  labels:
    {{- include "opencti.serverLabels" . | nindent 4 }}
spec:
  replicas: {{ .Values.server.replicaCount | default 1 }}
  {{- with .Values.server.strategy }}
  strategy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "opencti.serverSelectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        checksum/config: {{ include "opencti.serverEnv" . | sha256sum }}
        {{- with .Values.server.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "opencti.serverSelectorLabels" . | nindent 8 }}
        {{- with .Values.server.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "opencti.serviceAccountName" . }}
      {{- with .Values.server.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      initContainers:
        {{- /* Auto-wired readyCheckers â€” always enabled by default */}}
        {{- if .Values.readyChecker.enabled }}
        {{- if .Values.opensearch.enabled }}
        {{- include "opencti.readyChecker" (dict "name" "opensearch" "host" (.Values.opensearch.fullnameOverride | default (printf "%s-opensearch-cluster-master" .Release.Name)) "port" 9200 "retries" .Values.readyChecker.retries "timeout" .Values.readyChecker.timeout "image" .Values.readyChecker.image) | nindent 8 }}
        {{- else if .Values.externalElasticsearch.enabled }}
        {{- $esUrl := urlParse .Values.externalElasticsearch.url }}
        {{- include "opencti.readyChecker" (dict "name" "elasticsearch" "host" $esUrl.host "port" ($esUrl.port | default 9200) "retries" .Values.readyChecker.retries "timeout" .Values.readyChecker.timeout "image" .Values.readyChecker.image) | nindent 8 }}
        {{- end }}
        {{- if .Values.rabbitmq.enabled }}
        {{- include "opencti.readyChecker" (dict "name" "rabbitmq" "host" (printf "%s-rabbitmq" (include "opencti.fullname" .)) "port" 5672 "retries" .Values.readyChecker.retries "timeout" .Values.readyChecker.timeout "image" .Values.readyChecker.image) | nindent 8 }}
        {{- end }}
        {{- if .Values.externalRedis.enabled }}
        {{- include "opencti.readyChecker" (dict "name" "redis" "host" .Values.externalRedis.hostname "port" (.Values.externalRedis.port | default 6379) "retries" .Values.readyChecker.retries "timeout" .Values.readyChecker.timeout "image" .Values.readyChecker.image) | nindent 8 }}
        {{- end }}
        {{- if .Values.minio.enabled }}
        {{- include "opencti.readyChecker" (dict "name" "minio" "host" (printf "%s-minio" (include "opencti.fullname" .)) "port" 9000 "retries" .Values.readyChecker.retries "timeout" .Values.readyChecker.timeout "image" .Values.readyChecker.image) | nindent 8 }}
        {{- end }}
        {{- end }}
        {{- with .Values.server.initContainers }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      containers:
        - name: opencti-server
          {{- with .Values.server.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: http
              containerPort: {{ .Values.server.service.targetPort | default 4000 }}
              protocol: TCP
            {{- if .Values.opencti.metrics.enabled }}
            - name: metrics
              containerPort: {{ .Values.opencti.metrics.port | default 14269 }}
              protocol: TCP
            {{- end }}
          env:
            {{- include "opencti.serverEnv" . | nindent 12 }}
            {{- with .Values.server.extraEnv }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- with .Values.server.envFrom }}
          envFrom:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if .Values.server.livenessProbe.enabled }}
          livenessProbe:
            httpGet:
              path: /health?health_access_key={{ include "opencti.healthAccessKey" . }}
              port: http
            initialDelaySeconds: {{ .Values.server.livenessProbe.initialDelaySeconds | default 180 }}
            periodSeconds: {{ .Values.server.livenessProbe.periodSeconds | default 10 }}
            timeoutSeconds: {{ .Values.server.livenessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.server.livenessProbe.failureThreshold | default 3 }}
          {{- end }}
          {{- if .Values.server.readinessProbe.enabled }}
          readinessProbe:
            httpGet:
              path: /health?health_access_key={{ include "opencti.healthAccessKey" . }}
              port: http
            initialDelaySeconds: {{ .Values.server.readinessProbe.initialDelaySeconds | default 30 }}
            periodSeconds: {{ .Values.server.readinessProbe.periodSeconds | default 10 }}
            timeoutSeconds: {{ .Values.server.readinessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.server.readinessProbe.failureThreshold | default 3 }}
          {{- end }}
          {{- if .Values.server.startupProbe.enabled }}
          startupProbe:
            httpGet:
              path: /health?health_access_key={{ include "opencti.healthAccessKey" . }}
              port: http
            initialDelaySeconds: {{ .Values.server.startupProbe.initialDelaySeconds | default 0 }}
            periodSeconds: {{ .Values.server.startupProbe.periodSeconds | default 10 }}
            failureThreshold: {{ .Values.server.startupProbe.failureThreshold | default 30 }}
          {{- end }}
          {{- with .Values.server.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.server.volumeMounts }}
          volumeMounts:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      terminationGracePeriodSeconds: {{ .Values.server.terminationGracePeriodSeconds | default 30 }}
      {{- with .Values.server.volumes }}
      volumes:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.server.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.server.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.server.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
