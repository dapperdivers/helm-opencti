# ============================================================================
# values-dapper-cluster.yaml
# Production values for dapper-cluster (Derek's homelab)
#
# Usage:
#   helm install opencti ./charts/opencti \
#     -n opencti --create-namespace \
#     -f values-dapper-cluster.yaml \
#     -f charts/opencti/connector-presets/free-threat-intel.yaml \
#     --set opencti.adminPassword=<SECRET> \
#     --set opencti.adminToken=<UUID> \
#     --set rabbitmq.auth.password=<SECRET>
#
# Or with Flux HelmRelease — see flux/ directory.
# ============================================================================

fullnameOverride: opencti

opencti:
  adminEmail: derek@dapper.local
  # adminToken + adminPassword set via Infisical ExternalSecret
  adminTokenExistingSecret:
    name: opencti-credentials
    key: admin-token
  adminPasswordExistingSecret:
    name: opencti-credentials
    key: admin-password
  healthAccessKey: ""   # will use admin token

# -- External Redis → Dragonfly (already running in database namespace)
externalRedis:
  enabled: true
  hostname: dragonfly.database.svc.cluster.local
  port: 6379
  mode: single

# -- OpenSearch subchart (dedicated instance for CTI data)
opensearch:
  enabled: true
  replicas: 1
  opensearchJavaOpts: "-Xms4g -Xmx4g"
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      memory: 6Gi
  persistence:
    enabled: true
    size: 100Gi
    storageClass: openebs-hostpath    # fast local storage

# -- RabbitMQ subchart (dedicated for OpenCTI)
rabbitmq:
  enabled: true
  auth:
    username: opencti
    existingPasswordSecret: opencti-rabbitmq-credentials
  persistence:
    enabled: true
    size: 10Gi
    storageClass: openebs-hostpath
  extraConfiguration: |
    consumer_timeout = 86400000
    max_message_size = 536870912

# -- MinIO subchart (dedicated for OpenCTI file storage)
minio:
  enabled: true
  mode: standalone
  persistence:
    enabled: true
    size: 20Gi
    storageClass: openebs-hostpath
  # Credentials via ExternalSecret
  existingSecret: opencti-minio-credentials

# -- Server tuning
server:
  replicaCount: 1
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      memory: 8Gi

  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    hosts:
      - host: opencti.dapper.local
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: opencti-tls
        hosts:
          - opencti.dapper.local

# -- Workers
worker:
  enabled: true
  replicaCount: 3
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      memory: 1Gi
