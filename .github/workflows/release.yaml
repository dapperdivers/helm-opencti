name: Release Chart

on:
  push:
    branches: [main]
    paths:
      - "charts/opencti/**"
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@b9e51907a09c216f16ebe8536097933489208112 # v4.3.0

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Add Helm repos
        run: |
          helm repo add opensearch https://opensearch-project.github.io/helm-charts/
          helm repo add minio https://charts.min.io/
          helm repo update

      - name: Package chart
        run: |
          cd charts
          helm dependency build opencti
          helm package opencti

      - name: Push to OCI registry
        run: |
          PKG=$(ls charts/opencti-*.tgz)
          helm push "$PKG" oci://ghcr.io/dapperdivers/helm-opencti
          echo "Pushed $PKG"

      - name: Create GitHub Release
        if: github.event_name == 'push'
        run: |
          VERSION=$(grep '^version:' charts/opencti/Chart.yaml | awk '{print $2}')
          PKG=$(ls charts/opencti-*.tgz)
          gh release create "v${VERSION}" "$PKG" \
            --title "v${VERSION}" \
            --notes "OpenCTI chart v${VERSION} (appVersion $(grep '^appVersion:' charts/opencti/Chart.yaml | awk '{print $2}'))" \
            --latest 2>/dev/null || echo "Release v${VERSION} already exists, skipping"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
